#include <iostream>
#include <vector>
#include <string>
#include <limits>
#include <memory>
#include <CLI/CLI.hpp>
#include <nlohmann/json.hpp>
#include <filesystem>

class Vehicle {

protected:			//Durch protected sind diese vars auch für abgeleitete klassen verfügbar
	std::string name;
	int age;
	float retail_price;
	int sales_price;

public:
	Vehicle(std::string n, int a, float r, int s) : name(n), age(a), retail_price(r), sales_price(s) {}
	Vehicle(const nlohmann::json& J) : name(J["Name"]), age(J["Age"]), retail_price(J["Retail_price"]), sales_price(0) {}

	virtual ~Vehicle() = default;

	static Vehicle fromUserInput() {
		std::string n;
		int a, s;
		float r ;

		std::cout << "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";
		std::cout << "\n" << "Name: ";
		std::getline(std::cin, n);
		std::cout << "Age: ";
		std::cin >> a;
		std::cout << "Retail price: ";
		std::cin >> r;
		std::cout << "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";
		std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Necessary, cause otherwise this entry gets jumped
		return Vehicle(n, a, r, 0);
	}

	static Vehicle fromUserInput(std::string n, int a, int s, float r) {
		return Vehicle(n, a, r, 0);
	}

	virtual void print() const {
		std::cout 	<<"\n\n"
		            << "Name: " << name << "\n"
		            << "Age: " << age << "\n"
		            << "Retail price: " << retail_price << "\n\n";
	}


	void operator++() {			//adding the ++ operator
		age++;
	}
	
	virtual nlohmann::json makeJsonObject() const {
		nlohmann::json JsonVehicle = {
			{"Object", "Vehicle"},
			{"Name", name},
			{"Age", age},
			{"Retail_price", retail_price}
		};
		return JsonVehicle;
	}
};


class Bike : public Vehicle {
private:
	int number_of_tires = 2;

public:

	Bike(std::string n, int a, float r, int s) : Vehicle(n, a, r, s) {}
	Bike(const nlohmann::json J) : Vehicle(J) {}

	static Bike fromUserInput() {
		std::string n;
		int a, s;
		float r ;

		std::cout << "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";
		std::cout << "\n" << "Name: ";
		std::getline(std::cin, n);
		std::cout << "Age: ";
		std::cin >> a;
		std::cout << "Retail price: ";
		std::cin >> r;
		std::cout << "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";
		std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Necessary, cause otherwise this entry gets jumped
		return Bike(n, a, r, 0);
	}


	static Bike fromUserInput(std::string n, int a, int s, float r) {
		return Bike(n, a, r, 0);
	}
	void print() const override {
		std::cout 	<< "\n\n"
		            << "Name: " << name << "\n"
		            << "Age: " << age << "\n"
		            << "Retail price: " << retail_price << "\n"
		            << "Number of Tires: " << number_of_tires << "\n\n";
	}

	nlohmann::json makeJsonObject() const override {
		nlohmann::json JsonBike = {
			{"Object", "Bike"},
			{"Name", name},
			{"Age", age},
			{"Retail_price", retail_price},
			{"Number_of_Tires", number_of_tires}
		};
		return JsonBike;
	}
};

class Car : public Vehicle {
private:
	int number_of_tires = 4;

public:

	Car(std::string n, int a, float r, int s) : Vehicle(n, a, r, s) {}
	Car(const nlohmann::json J) : Vehicle(J) {}

	static Car fromUserInput() {
		std::string n;
		int a, s;
		float r ;

		std::cout << "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";
		std::cout << "\n" << "Name: ";
		std::getline(std::cin, n);
		std::cout << "Age: ";
		std::cin >> a;
		std::cout << "Retail price: ";
		std::cin >> r;
		std::cout << "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";
		std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Necessary, cause otherwise this entry gets jumped
		return Car(n, a, r, 0);
	}

	static Car fromUserInput(std::string n, int a, int s, float r) {
		return Car(n, a, r, 0);
	}

	void print() const override {
		std::cout 	<<"\n\n"
		            << "Name: " << name << "\n"
		            << "Age: " << age << "\n"
		            << "Retail price: " << retail_price << "\n"
		            << "Number of Tires: " << number_of_tires << "\n\n";
	}

	nlohmann::json  makeJsonObject() const override {
		nlohmann::json JsonCar = {
			{"Object", "Car"},
			{"Name", name},
			{"Age", age},
			{"Retail_price", retail_price},
			{"Number_of_Tires", number_of_tires}
		};
		return JsonCar;
	}
};


void print_Vehicles(std::vector<std::unique_ptr<Vehicle>>& Vehicles) {
	std::cout << "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";
	for(const auto& actualVehicle : Vehicles) {
		actualVehicle->print();
	}
}

void age_Vehicles(std::vector<std::unique_ptr<Vehicle>>& Vehicles) {	
	for(auto& actualcar : Vehicles) {
		++(*actualcar);		
	}

}

std::vector<nlohmann::json> create_json_vector(std::vector<std::unique_ptr<Vehicle>>& Vehicles) {
	std::vector<nlohmann::json> JsonVehicles;

	for (auto& actualVehicle : Vehicles) {

		JsonVehicles.push_back(actualVehicle->makeJsonObject());
	}

	return JsonVehicles;
}

std::vector<std::unique_ptr<Vehicle>> create_Vector(std::vector<nlohmann::json> JsonVehicles) {

	std::vector<std::unique_ptr<Vehicle>> Vehicles;
	for (auto& actualVehicle : JsonVehicles) {

		std::string n = actualVehicle ["Name"];
		int a = actualVehicle ["Age"];
		int s = 0;
		double r = actualVehicle["Retail_price"];
		if(!actualVehicle.contains("Number_of_Tires"))
			Vehicles.push_back(std::make_unique<Vehicle>(Vehicle::fromUserInput(n,a, 0,r)));

		if(actualVehicle.value("Number_of_Tires", 0) == 2)
			Vehicles.push_back(std::make_unique<Bike>(Bike::fromUserInput(n,a, 0,r)));

		if(actualVehicle.value("Number_of_Tires", 0) == 4)
			Vehicles.push_back(std::make_unique<Car>(Car::fromUserInput(n,a, 0,r)));
	}
	return Vehicles;
}

int SaveJsonVector(std::vector<nlohmann::json> JsonVehicles, std::string output_file) {

	if(output_file == "0") {

		while(!output_file.ends_with(".json") || !std::filesystem::exists(output_file)) {
			std::cout << "\nType Filename: ";
			std::cin >> output_file;
			if(!output_file.ends_with(".json"))
				std::cout <<"\n The Filename has to end on .json !\n\n";
			if(!std::filesystem::exists(output_file))
				std::cout <<"\n File does not exisit !\n\n";
		}
	}

	if(output_file != "0" && output_file.ends_with(".json") && std::filesystem::exists(output_file)) {
		std::ofstream out(output_file);
		out << static_cast<nlohmann::json>(JsonVehicles).dump(4);
		out.close();
	}

	return 0;
}

std::vector<nlohmann::json> LoadJsonVector(std::vector<nlohmann::json>& JsonVehicles, std::string input_file) {

	if (input_file == "0") {

		while(!input_file.ends_with(".json") || !std::filesystem::exists(input_file)) {

			std::cout << "\nType Filename: ";
			std::cin >> input_file;
			if(!input_file.ends_with(".json"))
				std::cout <<"\n The Filename has to end on .json !\n\n";
			if(!std::filesystem::exists(input_file))
				std::cout <<"\n File does not exisit !\n\n";
		}
	}

	if(input_file != "0" && input_file.ends_with(".json") && std::filesystem::exists(input_file)) {
		JsonVehicles.clear();
		std::ifstream in(input_file);
		nlohmann::json temp;
		in >> temp;
		for(const auto& obj : temp) {
			JsonVehicles.push_back(obj);
		}
	}
	return JsonVehicles;
}

int interactive_mode(std::vector<nlohmann::json>& JsonVehicles, std::vector<std::unique_ptr<Vehicle>>& Vehicles) {

	char choice;
	JsonVehicles = create_json_vector(Vehicles);
	while(1) {

		std::cout 	<< "Choose option:\n"
		            <<"(1) Create a Vehicle and insert at the end\n"
		            <<"(2) Create a Car and insert at the end\n"
		            <<"(3) Create a Bike and insert at the end\n"
		            <<"(4) Print list\n"
		            <<"(5) Delete Vehicles\n"
		            <<"(6) Age Vehicles\n"
		            <<"(s) Save\n"
		            <<"(l) Load\n"
		            <<"(q) Quit\n\n\n"
		            <<("Type option :");

		std::cin 	>> choice;
		std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n'); // Necessary, cause otherwise this entry gets jumped
		std::cout	<<"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n";

		std::string output_file = "0";
		std::string input_file = "0";

		switch(choice) {
		case '1':
			Vehicles.push_back(std::make_unique<Vehicle>(Vehicle::fromUserInput()));


			break;

		case '2':
			Vehicles.push_back(std::make_unique<Car>(Car::fromUserInput()));

			break;

		case '3':
			Vehicles.push_back(std::make_unique<Bike>(Bike::fromUserInput()));

			break;

		case '4':
			print_Vehicles(Vehicles);
			break;

		case '5':
			Vehicles.clear();

			break;

		case '6':
			age_Vehicles(Vehicles);



			break;

		case 's':							//Save funktion implementieren, wo man auch den filename eingeben kann.
			JsonVehicles = create_json_vector(Vehicles);
			SaveJsonVector(JsonVehicles, output_file);

			break;

		case 'l':							//Save funktion implementieren, wo man auch den filename eingeben kann.
			JsonVehicles = LoadJsonVector(JsonVehicles, input_file);
			Vehicles = create_Vector(JsonVehicles);
			break;


		case 'q':

			return 0;

		default:
			printf("Wrong character!\n");



		}

	}
}

int main (int argc, char** argv) {


	std::vector<std::unique_ptr<Vehicle>> Vehicles;
	std::vector<nlohmann::json> JsonVehicles;

	CLI::App app{"Car_Bike_Programm: CLI Version"};

	app.set_version_flag("--version", "1.0.0");

	bool commands = false;
	auto optCommands = app.add_flag("-c, --commands", commands, "Enable command mode");

	std::string name = "StandardName!";
	auto optName = app.add_option("-n, --name", name, "Add vehicles name")->needs(optCommands);

	int age = 0 ;
	auto optAge = app.add_option("-a, --age", age, "Add vehicles age")->needs(optCommands);

	float retail_price = 500;
	auto optRetailPrice = app.add_option("-r, --retail", retail_price, "Add vehicles retail_price")->needs(optCommands);

	std::string output_file = "Vector.json";
	auto optSave = app.add_option("-s , --save", output_file, "Save your Vehicles at this file")->check(CLI::ExistingFile);

	std::string input_file = "Vector.json";
	auto optLoad = app.add_option("-l , --load", input_file, "Load your Vehicles from this file")->check(CLI::ExistingFile);

	auto vehicle_group = app.add_option_group("Vehicle type", "At most one of the following options!!!");

	bool addVehicle = false;
	vehicle_group->add_flag("-V, --addVehicle", addVehicle, "Option for adding a Vehicle")
	->needs(optCommands)
	->needs(optName)
	->needs(optAge)
	->needs(optRetailPrice);

	bool addCar = false;
	vehicle_group->add_flag("-C, --addCar", addCar, "Option for adding a Car")
	->needs(optCommands)
	->needs(optName)
	->needs(optAge)
	->needs(optRetailPrice);

	bool addBike = false;
	vehicle_group->add_flag("-B, --addBike", addBike, "Option for adding a Bike")
	->needs(optCommands)
	->needs(optName)
	->needs(optAge)
	->needs(optRetailPrice);

	vehicle_group->require_option(0, 1);

	CLI11_PARSE(app, argc, argv);

	if(optLoad->count() > 0) {
		JsonVehicles = LoadJsonVector(JsonVehicles, input_file);
		Vehicles = create_Vector(JsonVehicles);
	}

	if(addVehicle) {
		Vehicles.push_back(std::make_unique<Vehicle>(Vehicle::fromUserInput(name,age, 0,retail_price)));
		Vehicles.back()->print();
	}

	if(addBike) {
		Vehicles.push_back(std::make_unique<Bike>(Bike::fromUserInput(name,age, 0,retail_price)));
		Vehicles.back()->print();
	}

	if(addCar) {
		Vehicles.push_back(std::make_unique<Car>(Car::fromUserInput(name,age, 0,retail_price)));
		Vehicles.back()->print();
	}

	if(optSave->count()  > 0) {
		JsonVehicles = create_json_vector(Vehicles);
		SaveJsonVector(JsonVehicles, output_file);
	}

	if(!commands)
		interactive_mode(JsonVehicles, Vehicles );

	return 0;



}


